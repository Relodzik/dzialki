package pl.gitdzialki;

import com.sk89q.worldedit.bukkit.BukkitAdapter;
import com.sk89q.worldedit.math.BlockVector3;
import com.sk89q.worldedit.world.World;
import com.sk89q.worldguard.WorldGuard;
import com.sk89q.worldguard.protection.managers.RegionManager;
import com.sk89q.worldguard.protection.regions.ProtectedCuboidRegion;
import com.sk89q.worldguard.protection.regions.ProtectedRegion;
import com.sk89q.worldguard.protection.regions.RegionContainer;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerMoveEvent;

import java.util.UUID;

public class PlayerMoveListener implements Listener {

    private final Main plugin;

    public PlayerMoveListener(Main plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    public void onPlayerMove(PlayerMoveEvent event) {
        Player player = event.getPlayer();
        Location from = event.getFrom();
        Location to = event.getTo();

        if (from.getBlockX() != to.getBlockX() || from.getBlockZ() != to.getBlockZ()) {
            boolean wasInPlot = isInPlotRegion(from);
            boolean isInPlot = isInPlotRegion(to);

            if (!wasInPlot && isInPlot) {
                String ownerName = getPlotOwnerName(to);
                player.sendMessage(ChatColor.GREEN + "Wszedłeś na teren działki " + ownerName + "!");
            } else if (wasInPlot && !isInPlot) {
                String ownerName = getPlotOwnerName(from);
                player.sendMessage(ChatColor.RED + "Wyszedłeś poza teren działki " + ownerName + "!");
            }
        }
    }

    private boolean isInPlotRegion(Location location) {
        World world = BukkitAdapter.adapt(location.getWorld()); // Konwersja org.bukkit.World na com.sk89q.worldedit.world.World
        RegionContainer container = WorldGuard.getInstance().getPlatform().getRegionContainer();
        RegionManager regions = container.get(world);

        if (regions != null) {
            for (ProtectedRegion region : regions.getRegions().values()) {
                if (region instanceof ProtectedCuboidRegion) {
                    BlockVector3 vector3 = BlockVector3.at(location.getBlockX(), location.getBlockY(), location.getBlockZ());
                    if (region.contains(vector3)) {
                        return region.getId().startsWith("dzialka_");
                    }
                }
            }
        }
        return false;
    }

    private String getPlotOwnerName(Location location) {
        World world = BukkitAdapter.adapt(location.getWorld()); // Konwersja org.bukkit.World na com.sk89q.worldedit.world.World
        RegionContainer container = WorldGuard.getInstance().getPlatform().getRegionContainer();
        RegionManager regions = container.get(world);

        if (regions != null) {
            for (ProtectedRegion region : regions.getRegions().values()) {
                if (region instanceof ProtectedCuboidRegion) {
                    BlockVector3 vector3 = BlockVector3.at(location.getBlockX(), location.getBlockY(), location.getBlockZ());
                    if (region.contains(vector3)) {
                        String regionName = region.getId();
                        String uuidString = regionName.replace("dzialka_", "");
                        UUID uuid = UUID.fromString(uuidString);
                        Player owner = plugin.getServer().getPlayer(uuid);
                        if (owner != null) {
                            return owner.getName();
                        }
                        return plugin.getServer().getOfflinePlayer(uuid).getName();
                    }
                }
            }
        }
        return "Nieznany właściciel";
    }
}