package pl.gitdzialki;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.wrappers.BlockPosition;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.entity.Player;
import org.bukkit.plugin.java.JavaPlugin;

public class PistonProtector {
    private final PlotManager plotManager;
    private final JavaPlugin plugin;

    public PistonProtector(JavaPlugin plugin, PlotManager plotManager) {
        this.plugin = plugin;
        this.plotManager = plotManager;
        registerPacketListener();
    }

    private void registerPacketListener() {
        ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(plugin, ListenerPriority.NORMAL,
                PacketType.Play.Client.BLOCK_DIG, PacketType.Play.Client.USE_ITEM) {

            @Override
            public void onPacketReceiving(PacketEvent event) {
                Player player = event.getPlayer();
                if (event.getPacketType() == PacketType.Play.Client.BLOCK_DIG) {
                    BlockPosition blockPos = event.getPacket().getBlockPositionModifier().read(0);
                    Location loc = new Location(player.getWorld(), blockPos.getX(), blockPos.getY(), blockPos.getZ());
                    handlePistonActivation(player, loc, event);
                }
            }
        });
    }

    private void handlePistonActivation(Player player, Location loc, PacketEvent event) {
        Block block = loc.getBlock();

        // Sprawdzenie, czy gracz aktywuje tłok
        if (block.getType() == Material.PISTON || block.getType() == Material.STICKY_PISTON) {
            // Jeśli tłok jest na działce, sprawdzamy właściciela
            if (plotManager.isPlot(loc)) {
                if (!plotManager.getPlotOwner(loc).equals(player.getUniqueId())) {
                    player.sendMessage("§cNie możesz aktywować tłoka na cudzej działce!");
                    event.setCancelled(true);
                }
            }
        }
    }
}
